<section class="h-full flex flex-col p-3 lg:p-4">
  <!-- <div class="mx-auto w-full max-w-full lg:max-w-6xl xl:max-w-7xl flex flex-col h-full"> -->
    <header
      class="flex items-center justify-between gap-3 mb-3 rounded-md bg-gray-200 dark:bg-gray-900 px-3 py-2 border border-gray-200 dark:text-blue-300">
      <h1 class="text-2xl font-semibold tracking-tight">Radio Editor</h1>
    </header>

    <div class="flex items-center gap-6 py-1 " *ngIf="visibleChannels().length">
        <div class="flex items-center gap-2 px-4 py-1 rounded-md border border-gray-300 bg-white dark:bg-gray-900 dark:text-blue-300 w-full justify-between">
          <div class="flex gap-2 items-center">
            <p class="text-blue-800 dark:text-gray-100"><strong *ngIf="playingChannel(); let playingC">{{ playingC.index + 1 }}</strong></p>

          <svg *ngIf="quedChannel() && !playingChannel()" class="animate-spin h-3 w-3"
            xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor"
              d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
            </path>
          </svg>

          <div class="flex gap-3 items-center">
            <p>{{ playingChannel()?.name || quedChannel()?.name }}</p>

            <app-favorite-check [checked]="playingChannel()?.favorite === '1'"
              (checkedChange)="toggleFavorite(playingChannel(), $event)"></app-favorite-check>
          </div>
          </div>

          <div class="flex items-center">
            <button (click)="playPreviousChannel(playingChannel())">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-6">
              <path fill-rule="evenodd"
                d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25Zm-4.28 9.22a.75.75 0 0 0 0 1.06l3 3a.75.75 0 1 0 1.06-1.06l-1.72-1.72h5.69a.75.75 0 0 0 0-1.5h-5.69l1.72-1.72a.75.75 0 0 0-1.06-1.06l-3 3Z"
                clip-rule="evenodd" />
            </svg>
          </button>

          <button (click)="audioElement?.paused ? audioElement?.play() : audioElement?.pause()"
            [disabled]="!playingChannel()">
            <svg *ngIf="!audioElement || audioElement.paused; else pauseTmpl" xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24" fill="currentColor" class="size-6">
              <path fill-rule="evenodd"
                d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12Zm14.024-.983a1.125 1.125 0 0 1 0 1.966l-5.603 3.113A1.125 1.125 0 0 1 9 15.113V8.887c0-.857.921-1.4 1.671-.983l5.603 3.113Z"
                clip-rule="evenodd" />
            </svg>

            <ng-template #pauseTmpl>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-6">
                <path fill-rule="evenodd"
                  d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12ZM9 8.25a.75.75 0 0 0-.75.75v6c0 .414.336.75.75.75h.75a.75.75 0 0 0 .75-.75V9a.75.75 0 0 0-.75-.75H9Zm5.25 0a.75.75 0 0 0-.75.75v6c0 .414.336.75.75.75H15a.75.75 0 0 0 .75-.75V9a.75.75 0 0 0-.75-.75h-.75Z"
                  clip-rule="evenodd" />
              </svg>
            </ng-template>
          </button>

          <button (click)="playNextChannel(playingChannel())">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-6">
              <path fill-rule="evenodd"
                d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25Zm4.28 10.28a.75.75 0 0 0 0-1.06l-3-3a.75.75 0 1 0-1.06 1.06l1.72 1.72H8.25a.75.75 0 0 0 0 1.5h5.69l-1.72 1.72a.75.75 0 1 0 1.06 1.06l3-3Z"
                clip-rule="evenodd" />
            </svg>
          </button>

          <div class="flex items-center gap-1">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
              stroke="currentColor" class="size-4">
              <path stroke-linecap="round" stroke-linejoin="round"
                d="M17.25 9.75 19.5 12m0 0 2.25 2.25M19.5 12l2.25-2.25M19.5 12l-2.25 2.25m-10.5-6 4.72-4.72a.75.75 0 0 1 1.28.53v15.88a.75.75 0 0 1-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.507-1.938-1.354A9.009 9.009 0 0 1 2.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75Z" />
            </svg>

            <input type="range" [min]="0" [max]="1" step="0.01"
              (input)="audioElement && (audioElement.volume = +$event.target.value)"
              [value]="audioElement ? audioElement.volume : 1" />

            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
              stroke="currentColor" class="size-4">
              <path stroke-linecap="round" stroke-linejoin="round"
                d="M19.114 5.636a9 9 0 0 1 0 12.728M16.463 8.288a5.25 5.25 0 0 1 0 7.424M6.75 8.25l4.72-4.72a.75.75 0 0 1 1.28.53v15.88a.75.75 0 0 1-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.507-1.938-1.354A9.009 9.009 0 0 1 2.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75Z" />
            </svg>
          </div>
          </div>
        </div>
      </div>

    <div class="mb-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="text-sm dark:text-blue-600" *ngIf="loaded()">
          Total channels: <span class="font-medium">{{ visibleChannels().length }}</span>
        </div>
        <div *ngIf="hasChanges()" class="text-sm text-amber-600 font-medium">
          ⚠️ Unsaved changes
        </div>
        <button *ngIf="hasChanges()" type="button" (click)="onSave()" [class.bg-green-600]="hasChanges()"
          [class.hover:bg-green-700]="hasChanges()" [class.bg-gray-400]="!hasChanges()"
          [class.cursor-not-allowed]="!hasChanges()"
          class="inline-flex items-center gap-2 rounded-md text-white text-sm px-3 py-1.5">
          Save Changes
        </button>
        <button type="button" (click)="resetChanges()" *ngIf="hasChanges()"
          class="inline-flex items-center gap-2 rounded-md border border-red-300 bg-white text-red-600 text-sm px-3 py-1.5 hover:bg-red-50">
          Reset Changes
        </button>
      </div>

      <div class="flex items-center gap-2" *ngIf="visibleChannels().length">
        <button type="button" (click)="initNewChannel()"
          class="inline-flex items-center gap-1 rounded-md bg-blue-600 text-white text-sm px-3 py-1.5 hover:bg-blue-700">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
          </svg>
          Add Channel
        </button>
        <button type="button" (click)="onImport()"
          class="inline-flex items-center gap-1 rounded-md bg-gray-300 dark:bg-gray-600 dark:text-white text-sm px-3 py-1.5 hover:bg-gray-200 hover:dark:bg-blue-700">
          Import
        </button>
        <button type="button" (click)="onExport()"
          class="inline-flex items-center gap-1 rounded-md bg-gray-300 dark:bg-gray-600 dark:text-white text-sm px-3 py-1.5 hover:bg-gray-200 hover:dark:bg-blue-700">
          Export
        </button>
      </div>
    </div>

    <div *ngIf="loading()" class="rounded-xl border border-white/5 bg-[var(--ets-panel)]/95 p-6">
      <div class="animate-pulse h-4 bg-white/10 rounded w-40 mb-3"></div>
      <div class="animate-pulse h-4 bg-white/10 rounded w-64"></div>
    </div>

    <div *ngIf="showAddForm()" class="mb-3 p-4 rounded-md border border-blue-200 bg-blue-50 dark:bg-blue-300">
      <div class="flex items-end gap-2">
        <div class="flex-1 grid grid-cols-7 gap-2">
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">Index</label>
            <input type="number" [(ngModel)]="newChannel.index" [ngModelOptions]="{standalone: true}" [min]="0"
              [max]="getNextIndex()"
              class="w-full px-2 py-1 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 text-sm">
          </div>
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">Name *</label>
            <input type="text" [(ngModel)]="newChannel.name" [ngModelOptions]="{standalone: true}"
              placeholder="Station Name"
              class="w-full px-2 py-1 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 text-sm">
          </div>
          <div class="col-span-2">
            <label class="block text-xs font-medium text-gray-700 mb-1">URL *</label>
            <input type="url" [(ngModel)]="newChannel.url" [ngModelOptions]="{standalone: true}"
              placeholder="http://..."
              class="w-full px-2 py-1 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 text-sm">
          </div>
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">Genre</label>
            <input type="text" [(ngModel)]="newChannel.genre" [ngModelOptions]="{standalone: true}"
              placeholder="Pop, Rock"
              class="w-full px-2 py-1 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 text-sm">
          </div>
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">Lang</label>
            <input type="text" [(ngModel)]="newChannel.lang" [ngModelOptions]="{standalone: true}" maxlength="5"
              placeholder="EN"
              class="w-full px-2 py-1 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 text-sm text-center">
          </div>
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">Bitrate</label>
            <input type="text" [(ngModel)]="newChannel.bitrate" [ngModelOptions]="{standalone: true}" pattern="[0-9]*"
              placeholder="128"
              class="w-full px-2 py-1 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 text-sm text-center">
          </div>
        </div>
        <div class="flex items-center gap-2">
          <label class="flex items-center gap-1">
            <app-favorite-check [checked]="newChannel.favorite === '1'"
              (checkedChange)="onNewChannelFavoriteChange($event)"></app-favorite-check>
          </label>
          <button type="button" (click)="testStreamUrl(newChannel.url || '')" [disabled]="!newChannel.url"
            [class.bg-red-500]="playingStreamUrl() === newChannel.url"
            [class.hover:bg-red-600]="playingStreamUrl() === newChannel.url" [class.bg-orange-500]="errorIndex() === -1"
            [class.hover:bg-orange-600]="errorIndex() === -1"
            [class.bg-gray-900]="playingStreamUrl() !== newChannel.url && loadingIndex() !== -1 && errorIndex() !== -1"
            [class.hover:bg-black/80]="loadingIndex() === -1 || !newChannel.url"
            [class.bg-gray-400]="loadingIndex() === -1"
            class="inline-flex items-center justify-center gap-1 rounded text-white text-xs px-1 py-1 w-12">
            <svg *ngIf="loadingIndex() === -1" class="animate-spin h-3 w-3" xmlns="http://www.w3.org/2000/svg"
              fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor"
                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
              </path>
            </svg>
            <svg *ngIf="errorIndex() === -1 && loadingIndex() !== -1" class="h-3 w-3" xmlns="http://www.w3.org/2000/svg"
              fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span *ngIf="loadingIndex() !== -1 && errorIndex() !== -1">{{ playingStreamUrl() === newChannel.url ? 'Stop'
              : 'Test' }}</span>
            <span *ngIf="errorIndex() === -1 && loadingIndex() !== -1">Retry</span>
          </button>

          <button type="button" (click)="addChannel()"
            class="inline-flex items-center gap-1 rounded-md bg-green-600 text-white text-sm px-3 py-1.5 hover:bg-green-700">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            Add
          </button>
          <button type="button" (click)="cancelAddChannel()"
            class="inline-flex items-center gap-1 rounded-md border border-gray-300 bg-white text-gray-700 text-sm px-3 py-1.5 hover:bg-gray-50">
            Cancel
          </button>
        </div>
      </div>
    </div>

    <!-- <div style="height: 1000px;" class="bg-blue-200 overflow-x-auto overflow-y-auto">
      SOMETHING TO SCROLL
    </div> -->

    <div *ngIf="!loading() && showList()"
      class="flex-1 overflow-hidden rounded-md border border-gray-200 bg-white text-black flex flex-col">
      <div class="overflow-x-auto overflow-y-auto flex-1
        [&::-webkit-scrollbar]:w-6
        [&::-webkit-scrollbar-track]:bg-gray-100
        [&::-webkit-scrollbar-thumb]:bg-gray-300
        dark:[&::-webkit-scrollbar-track]:bg-gray-900
        dark:[&::-webkit-scrollbar-thumb]:bg-gray-500">

        <table *ngIf="visibleChannels().length" class="min-w-[900px] w-full text-sm table-auto border-collapse">
          <thead class="text-left bg-gray-200 dark:bg-gray-900 dark:text-blue-300 sticky top-0 z-10">
            <tr class="border-b border-gray-200">
              <th class="py-2 px-2 w-12">#</th>
              <th class="py-2 px-2 min-w-[150px]">Name
                <button class="text-blue-500" (click)="sortChannelsByField('name', 'asc')">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                    stroke="currentColor" class="size-4">
                    <path stroke-linecap="round" stroke-linejoin="round" d="m4.5 18.75 7.5-7.5 7.5 7.5" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 7.5-7.5 7.5 7.5" />
                  </svg>
                </button>

                <button class="text-blue-500" (click)="sortChannelsByField('name', 'desc')">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                    stroke="currentColor" class="size-4">
                    <path stroke-linecap="round" stroke-linejoin="round"
                      d="m4.5 5.25 7.5 7.5 7.5-7.5m-15 6 7.5 7.5 7.5-7.5" />
                  </svg>
                </button>
              </th>
              <th class="py-2 px-2 min-w-[300px]">URL</th>
              <th class="py-2 px-2 min-w-[100px]">Genre
                <button class="text-blue-500" (click)="sortChannelsByField('genre', 'asc')">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                    stroke="currentColor" class="size-4">
                    <path stroke-linecap="round" stroke-linejoin="round" d="m4.5 18.75 7.5-7.5 7.5 7.5" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 7.5-7.5 7.5 7.5" />
                  </svg>
                </button>
                <button class="text-blue-500" (click)="sortChannelsByField('genre', 'desc')">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                    stroke="currentColor" class="size-4">
                    <path stroke-linecap="round" stroke-linejoin="round"
                      d="m4.5 5.25 7.5 7.5 7.5-7.5m-15 6 7.5 7.5 7.5-7.5" />
                  </svg>
                </button>
              </th>
              <th class="py-2 px-2 w-16">Lang</th>
              <th class="py-2 px-2 w-20">Bitrate</th>
              <th class="py-2 px-2 min-w-[100px]">Fav
                <button class="text-blue-500" (click)="sortChannelsByField('favorite', 'asc')">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                    stroke="currentColor" class="size-4">
                    <path stroke-linecap="round" stroke-linejoin="round" d="m4.5 18.75 7.5-7.5 7.5 7.5" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 7.5-7.5 7.5 7.5" />
                  </svg>
                </button>

                <button class="text-blue-500" (click)="sortChannelsByField('favorite', 'desc')">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                    stroke="currentColor" class="size-4">
                    <path stroke-linecap="round" stroke-linejoin="round"
                      d="m4.5 5.25 7.5 7.5 7.5-7.5m-15 6 7.5 7.5 7.5-7.5" />
                  </svg>
                </button>
              </th>
              <th class="py-2 px-2 w-16">Play</th>
              <th class="py-2 px-2 w-16">Actions</th>
            </tr>
          </thead>
          <tbody class="bg-gray-50 dark:bg-gray-700  dark:text-gray-100">
            <tr *ngFor="let ch of visibleChannels()" class="border-b border-gray-200 dark:border-blue-300"
              [class.bg-blue-200]="playingStreamUrl() === ch.url"
              [class.dark:bg-blue-800]="playingStreamUrl() === ch.url">
              <td class="py-2 px-2 text-xs">{{ ch.index + 1 }}</td>
              <td class="py-1 px-2">
                <div class="flex items-center gap-1">
                  <input type="text" [value]="getFieldValue(ch.index, 'name')"
                    (input)="onFieldEdit(ch.index, 'name', $event)" (keydown)="onFieldKeydown(ch.index, 'name', $event)"
                    [class.bg-yellow-50]="isFieldModified(ch.index, 'name')" placeholder="Unnamed Station"
                    class="flex-1 px-1 py-1 bg-transparent border-0 focus:outline-none focus:ring-1 focus:ring-blue-500 rounded">
                  <button *ngIf="hasFieldPendingChanges(ch.index, 'name')" (click)="applyFieldChange(ch.index, 'name')"
                    title="Apply change" class="text-blue-600 hover:text-blue-700 p-0.5">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                      <path
                        d="M17 3H5C3.89 3 3 3.9 3 5V19C3 20.1 3.89 21 5 21H19C20.1 21 21 20.1 21 19V7L17 3ZM19 19H5V5H16.17L19 7.83V19ZM12 12C10.34 12 9 13.34 9 15S10.34 18 12 18 15 16.66 15 15 13.66 12 12 12ZM6 6H15V10H6V6Z" />
                    </svg>
                  </button>
                </div>
              </td>
              <td class="py-1 px-2">
                <div class="flex items-center gap-1">
                  <input type="url" [value]="getFieldValue(ch.index, 'url')"
                    (input)="onFieldEdit(ch.index, 'url', $event)" (keydown)="onFieldKeydown(ch.index, 'url', $event)"
                    [class.bg-yellow-50]="isFieldModified(ch.index, 'url')"
                    class="flex-1 px-1 py-1 bg-transparent border-0 focus:outline-none focus:ring-1 focus:ring-blue-500 rounded text-xs break-all">
                  <button *ngIf="hasFieldPendingChanges(ch.index, 'url')" (click)="applyFieldChange(ch.index, 'url')"
                    title="Apply change" class="text-blue-600 hover:text-blue-700 p-0.5">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                      <path
                        d="M17 3H5C3.89 3 3 3.9 3 5V19C3 20.1 3.89 21 5 21H19C20.1 21 21 20.1 21 19V7L17 3ZM19 19H5V5H16.17L19 7.83V19ZM12 12C10.34 12 9 13.34 9 15S10.34 18 12 18 15 16.66 15 15 13.66 12 12 12ZM6 6H15V10H6V6Z" />
                    </svg>
                  </button>
                </div>
              </td>
              <td class="py-1 px-2">
                <div class="flex items-center gap-1">
                  <input type="text" [value]="getFieldValue(ch.index, 'genre')"
                    (input)="onFieldEdit(ch.index, 'genre', $event)"
                    (keydown)="onFieldKeydown(ch.index, 'genre', $event)"
                    [class.bg-yellow-50]="isFieldModified(ch.index, 'genre')"
                    class="flex-1 px-1 py-1 bg-transparent border-0 focus:outline-none focus:ring-1 focus:ring-blue-500 rounded">
                  <button *ngIf="hasFieldPendingChanges(ch.index, 'genre')"
                    (click)="applyFieldChange(ch.index, 'genre')" title="Apply change"
                    class="text-blue-600 hover:text-blue-700 p-0.5">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                      <path
                        d="M17 3H5C3.89 3 3 3.9 3 5V19C3 20.1 3.89 21 5 21H19C20.1 21 21 20.1 21 19V7L17 3ZM19 19H5V5H16.17L19 7.83V19ZM12 12C10.34 12 9 13.34 9 15S10.34 18 12 18 15 16.66 15 15 13.66 12 12 12ZM6 6H15V10H6V6Z" />
                    </svg>
                  </button>
                </div>
              </td>
              <td class="py-1 px-2">
                <div class="flex items-center gap-1">
                  <input type="text" [value]="getFieldValue(ch.index, 'lang')"
                    (input)="onFieldEdit(ch.index, 'lang', $event)" (keydown)="onFieldKeydown(ch.index, 'lang', $event)"
                    [class.bg-yellow-50]="isFieldModified(ch.index, 'lang')" maxlength="5"
                    class="flex-1 px-1 py-1 bg-transparent border-0 focus:outline-none focus:ring-1 focus:ring-blue-500 rounded text-center w-10">
                  <button *ngIf="hasFieldPendingChanges(ch.index, 'lang')" (click)="applyFieldChange(ch.index, 'lang')"
                    title="Apply change" class="text-blue-600 hover:text-blue-700 p-0.5">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                      <path
                        d="M17 3H5C3.89 3 3 3.9 3 5V19C3 20.1 3.89 21 5 21H19C20.1 21 21 20.1 21 19V7L17 3ZM19 19H5V5H16.17L19 7.83V19ZM12 12C10.34 12 9 13.34 9 15S10.34 18 12 18 15 16.66 15 15 13.66 12 12 12ZM6 6H15V10H6V6Z" />
                    </svg>
                  </button>
                </div>
              </td>
              <td class="py-1 px-2">
                <div class="flex items-center gap-1">
                  <input type="text" [value]="getFieldValue(ch.index, 'bitrate')"
                    (input)="onFieldEdit(ch.index, 'bitrate', $event)"
                    (keydown)="onFieldKeydown(ch.index, 'bitrate', $event)"
                    [class.bg-yellow-50]="isFieldModified(ch.index, 'bitrate')" pattern="[0-9]*" placeholder="0"
                    class="flex-1 px-1 py-1 bg-transparent border-0 focus:outline-none focus:ring-1 focus:ring-blue-500 rounded text-center">
                  <button *ngIf="hasFieldPendingChanges(ch.index, 'bitrate')"
                    (click)="applyFieldChange(ch.index, 'bitrate')" title="Apply change"
                    class="text-blue-600 hover:text-blue-700 p-0.5">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                      <path
                        d="M17 3H5C3.89 3 3 3.9 3 5V19C3 20.1 3.89 21 5 21H19C20.1 21 21 20.1 21 19V7L17 3ZM19 19H5V5H16.17L19 7.83V19ZM12 12C10.34 12 9 13.34 9 15S10.34 18 12 18 15 16.66 15 15 13.66 12 12 12ZM6 6H15V10H6V6Z" />
                    </svg>
                  </button>
                </div>
              </td>
              <td class="py-1 px-2 text-center">
                <app-favorite-check size="4" [checked]="ch.favorite === '1'"
                  (checkedChange)="toggleFavorite(ch, $event)"></app-favorite-check>
              </td>
              <td class="py-1 px-1">
                <button type="button" (click)="playStream(ch)" style="width: 100px;"
                  [class.bg-red-500]="playingStreamUrl() === ch.url"
                  [class.hover:bg-red-600]="playingStreamUrl() === ch.url"
                  [class.bg-orange-500]="errorIndex() === ch.index"
                  [class.hover:bg-orange-600]="errorIndex() === ch.index"
                  [class.bg-gray-900]="playingStreamUrl() !== ch.url && loadingIndex() !== ch.index && errorIndex() !== ch.index"
                  [class.hover:bg-black/80]="playingStreamUrl() !== ch.url && loadingIndex() !== ch.index && errorIndex() !== ch.index"
                  [class.bg-gray-400]="loadingIndex() === ch.index"
                  class="inline-flex items-center justify-center gap-1 rounded text-white text-xs px-1 py-1 w-12">
                  <svg *ngIf="loadingIndex() === ch.index" class="animate-spin h-3 w-3"
                    xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor"
                      d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                    </path>
                  </svg>
                  <svg *ngIf="errorIndex() === ch.index && loadingIndex() !== ch.index" class="h-3 w-3"
                    xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  <span *ngIf="loadingIndex() !== ch.index && errorIndex() !== ch.index">{{ playingStreamUrl() ===
                    ch.url ? 'Stop' : 'Play' }}</span>
                  <span *ngIf="errorIndex() === ch.index && loadingIndex() !== ch.index">Retry</span>
                  <span *ngIf="loadingIndex() === ch.index">Stop</span>
                </button>
              </td>
              <td class="py-1 px-1">
                <button type="button" (click)="removeChannel(ch.index)" title="Remove channel"
                  class="inline-flex items-center justify-center p-0.5 rounded text-red-600 hover:bg-red-50 hover:text-red-700">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                    </path>
                  </svg>
                </button>
              </td>
            </tr>
          </tbody>
        </table>

        <div *ngIf="!visibleChannels().length" class="flex flex-col items-center justify-center h-full py-10">
          <p class="text-center text-gray-500 py-4 mb-3">No channels found.</p>
          <button type="button" (click)="onImport()"
            class="inline-flex items-center gap-1 rounded-md bg-gray-300 dark:bg-gray-600 dark:text-white text-sm px-3 py-1.5 hover:bg-gray-200 hover:dark:bg-blue-700">
            Import
          </button>
        </div>
      </div>
    </div>
</section>
